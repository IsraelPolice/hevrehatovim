<!DOCTYPE html>
<html lang="he">
<head>
    <meta charset="UTF-8">
    <title>מלחמת הבלאקיף</title>
    <link href="https://fonts.googleapis.com/css2?family=Rubik:wght@400;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Rubik', sans-serif;
            text-align: center;
            background: linear-gradient(135deg, #0d1b2a, #1b263b, #415a77);
            color: #e0e1dd;
            direction: rtl;
            margin: 0;
            padding: 20px;
            min-height: 100vh;
            overflow-x: hidden;
            animation: glowBackground 5s infinite alternate;
        }

        @keyframes glowBackground {
            0% { background: linear-gradient(135deg, #0d1b2a, #1b263b, #415a77); }
            100% { background: linear-gradient(135deg, #1b263b, #415a77, #778da9); }
        }

        h1 {
            color: #00ffcc;
            text-shadow: 0 0 5px #00ffcc;
            font-size: 3em;
            font-weight: 700;
            margin-bottom: 20px;
        }

        h2 {
            color: #ff0066;
            text-shadow: 0 0 5px #ff0066;
            font-size: 2em;
        }

        .character-card {
            display: inline-block;
            margin: 15px;
            padding: 15px;
            background: rgba(255, 255, 255, 0.1);
            border: 2px solid #00ffcc;
            border-radius: 15px;
            box-shadow: 0 0 15px #00ffcc;
            cursor: pointer;
            transition: transform 0.3s, box-shadow 0.3s;
            width: 200px;
            text-align: center;
        }

        .character-card:hover {
            transform: scale(1.1);
            box-shadow: 0 0 25px #ff0066;
        }

        .character-card.selected {
            border-color: #ff0066;
            box-shadow: 0 0 20px #ff0066;
        }

        .character-card img {
            border-radius: 10px;
            width: 120px;
            height: 120px;
            object-fit: cover;
        }

        .team-card {
            display: inline-block;
            margin: 20px;
            padding: 20px;
            width: 220px;
            height: 350px;
            background: linear-gradient(135deg, rgba(0, 255, 204, 0.2), rgba(255, 0, 102, 0.2));
            border: 2px solid #ff0066;
            border-radius: 15px;
            box-shadow: 0 0 20px #ff0066;
            position: relative;
            animation: dropFromSpace 1.5s ease-out forwards;
        }

        @keyframes dropFromSpace {
            0% { transform: translateY(-100vh) scale(0.5); opacity: 0; }
            50% { transform: translateY(20px) scale(1.1); opacity: 0.7; }
            100% { transform: translateY(0) scale(1); opacity: 1; }
        }

        .team-card img.player-img {
            width: 130px;
            height: 130px;
            border-radius: 10px;
            margin-top: 20px;
            border: 2px solid #00ffcc;
        }

        .team-card .name { font-size: 22px; color: #00ffcc; text-shadow: 0 0 5px #00ffcc; }
        .team-card .overall { font-size: 20px; color: #e0e1dd; }
        .team-card .stars { font-size: 18px; color: #ff0066; }
        .team-card .flag { position: absolute; top: 10px; right: 10px; width: 40px; }

        button {
            padding: 12px 25px;
            font-size: 18px;
            background: #ff0066;
            color: #e0e1dd;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            box-shadow: 0 0 10px #ff0066;
            transition: transform 0.3s, box-shadow 0.3s;
        }

        button:hover {
            transform: scale(1.05);
            box-shadow: 0 0 20px #ff0066;
        }

        button:disabled {
            background: #555;
            box-shadow: none;
            cursor: not-allowed;
        }

        select {
            padding: 8px;
            font-size: 16px;
            background: rgba(255, 255, 255, 0.1);
            color: #e0e1dd;
            border: 1px solid #00ffcc;
            border-radius: 5px;
            margin-top: 10px;
        }

        .popup {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: linear-gradient(135deg, #1b263b, #415a77);
            border: 2px solid #ff0066;
            padding: 20px;
            border-radius: 15px;
            box-shadow: 0 0 30px #ff0066;
            z-index: 1000;
            text-align: center;
            animation: popupGlow 2s infinite alternate;
        }

        @keyframes popupGlow {
            0% { box-shadow: 0 0 30px #ff0066; }
            100% { box-shadow: 0 0 50px #00ffcc; }
        }

        .popup.fancy {
            background: linear-gradient(135deg, #ff0066, #00ffcc);
            color: #000;
            font-weight: bold;
            border: 4px solid #e0e1dd;
            box-shadow: 0 0 40px #ff0066, 0 0 60px #00ffcc;
        }

        .popup img {
            width: 120px;
            height: 120px;
            border-radius: 10px;
            margin-bottom: 15px;
        }

        .message-popup {
            position: fixed;
            bottom: 20px;
            left: 20px;
            width: 300px;
            background: rgba(0, 0, 0, 0.8);
            border: 1px solid #00ffcc;
            padding: 15px;
            border-radius: 10px;
            box-shadow: 0 0 15px #00ffcc;
            z-index: 1000;
            text-align: right;
            animation: slideIn 0.5s ease-out;
        }

        .message-popup img {
            width: 50px;
            height: 50px;
            border-radius: 5px;
            float: right;
            margin-left: 10px;
        }

        @keyframes slideIn {
            0% { transform: translateX(-100%); opacity: 0; }
            100% { transform: translateX(0); opacity: 1; }
        }

        .battle-text {
            font-size: 1.5em;
            color: #ff0066;
            text-shadow: 0 0 10px #ff0066;
            animation: pulse 1s infinite alternate;
        }

        @keyframes pulse {
            0% { transform: scale(1); }
            100% { transform: scale(1.05); }
        }

        .health-bar {
            width: 100%;
            background: #333;
            height: 20px;
            border-radius: 10px;
            margin: 5px 0;
            overflow: hidden;
        }

        .health-bar-fill {
            height: 100%;
            background: #00ffcc;
            transition: width 0.5s ease;
        }
    </style>
</head>
<body>
    <h1>מלחמת הבלאקיף</h1>
    <div id="character-selection"></div>
    <button id="confirm-team" disabled>אשר צוות</button>
    <div id="team-display" style="display: none;"></div>
    <div id="battle-display" style="display: none;"></div>

    <script>
        const characters = [
            { name: "אור דהן", overall: 79, image: "https://i.postimg.cc/13r31pJG/IMG-5054.jpg", flag: "https://upload.wikimedia.org/wikipedia/commons/thumb/d/d4/Flag_of_Israel.svg/1200px-Flag_of_Israel.svg.png" },
            { name: "יוסף קחלר", overall: 88, image: "https://i.postimg.cc/KYcvGRHd/IMG-4721-2.jpg", flag: "https://upload.wikimedia.org/wikipedia/commons/thumb/f/f6/Flag_of_Iraq.svg/1200px-Flag_of_Iraq.svg.png" },
            { name: "עמית לסרי", overall: 90, image: "https://i.postimg.cc/Y2T962vW/IMG-5056.jpg", flag: "https://upload.wikimedia.org/wikipedia/commons/thumb/d/d4/Flag_of_Israel.svg/1200px-Flag_of_Israel.svg.png" },
            { name: "איציק מור יוסף", overall: 82, image: "https://i.postimg.cc/SQnRYYx4/IMG-5057.jpg", flag: "https://upload.wikimedia.org/wikipedia/commons/thumb/d/d4/Flag_of_Israel.svg/1200px-Flag_of_Israel.svg.png" },
            { name: "איתי אוחנה", overall: 90, image: "https://i.postimg.cc/DwTwNCdf/IMG-5058.jpg", flag: "https://upload.wikimedia.org/wikipedia/commons/thumb/d/d4/Flag_of_Israel.svg/1200px-Flag_of_Israel.svg.png" },
            { name: "ג׳ורדן בוחבוט", overall: 86, image: "https://i.postimg.cc/zvbsDr5m/IMG-5059.jpg", flag: "https://upload.wikimedia.org/wikipedia/commons/thumb/d/d4/Flag_of_Israel.svg/1200px-Flag_of_Israel.svg.png" },
            { name: "דביר אוחנה", overall: 92, image: "https://i.postimg.cc/J0f9G24s/IMG-5060.jpg", flag: "https://upload.wikimedia.org/wikipedia/commons/thumb/d/d4/Flag_of_Israel.svg/1200px-Flag_of_Israel.svg.png" },
            { name: "דור אביכזר", overall: 80, image: "https://i.postimg.cc/vBNRdmJL/IMG-5061.jpg", flag: "https://upload.wikimedia.org/wikipedia/commons/thumb/d/d4/Flag_of_Israel.svg/1200px-Flag_of_Israel.svg.png" },
            { name: "יוגב שבתאי", overall: 74, image: "https://i.postimg.cc/TYmPC8bH/IMG-5062.jpg", flag: "https://upload.wikimedia.org/wikipedia/commons/thumb/d/d4/Flag_of_Israel.svg/1200px-Flag_of_Israel.svg.png" },
            { name: "ליאב בן יעקב", overall: 83, image: "https://i.postimg.cc/Sss059vx/IMG-5063.jpg", flag: "https://upload.wikimedia.org/wikipedia/commons/thumb/d/d4/Flag_of_Israel.svg/1200px-Flag_of_Israel.svg.png" },
            { name: "אריאל עין גל", overall: 58, image: "https://i.postimg.cc/k5w3fsw-H/IMG-5064.jpg", flag: "https://upload.wikimedia.org/wikipedia/commons/thumb/d/d4/Flag_of_Israel.svg/1200px-Flag_of_Israel.svg.png" },
            { name: "מיכה גורלובסקי", overall: 85, image: "https://i.postimg.cc/jjRYHm6N/IMG-5065.jpg", flag: "https://upload.wikimedia.org/wikipedia/commons/thumb/d/d4/Flag_of_Israel.svg/1200px-Flag_of_Israel.svg.png" },
            { name: "קורן בן משה", overall: 89, image: "https://i.postimg.cc/wjXdsgNg/IMG-5066.jpg", flag: "https://upload.wikimedia.org/wikipedia/commons/thumb/d/d4/Flag_of_Israel.svg/1200px-Flag_of_Israel.svg.png" },
            { name: "נתנאל יוסילביץ׳", overall: 82, image: "https://i.postimg.cc/wMndDBFT/IMG-5068.jpg", flag: "https://upload.wikimedia.org/wikipedia/commons/thumb/d/d4/Flag_of_Israel.svg/1200px-Flag_of_Israel.svg.png" },
            { name: "חיים מרקס", overall: 66, image: "https://i.postimg.cc/MHnScB7F/IMG-5069.jpg", flag: "https://upload.wikimedia.org/wikipedia/commons/thumb/a/a4/Flag_of_the_United_States.svg/1200px-Flag_of_the_United_States.svg.png" },
            { name: "רפי אלגרבלי", overall: 71, image: "https://i.postimg.cc/9MFVhKrV/IMG-5070.jpg", flag: "https://upload.wikimedia.org/wikipedia/commons/thumb/0/00/Flag_of_Palestine.svg/1200px-Flag_of_Palestine.svg.png" },
            { name: "יעקב שוורץ", overall: 88, image: "https://i.postimg.cc/nzRxc2Dm/IMG-5071.jpg", flag: "https://upload.wikimedia.org/wikipedia/commons/thumb/d/d4/Flag_of_Israel.svg/1200px-Flag_of_Israel.svg.png" },
            { name: "אריאל שרביט", overall: 57, image: "https://i.postimg.cc/TPcGBf2C/IMG-5072.jpg", flag: "https://upload.wikimedia.org/wikipedia/commons/thumb/d/d4/Flag_of_Israel.svg/1200px-Flag_of_Israel.svg.png" },
            { name: "דביר ברקת", overall: 96, image: "https://www.qube.co.il/images/ency/bands/DvirBareket.jpg", flag: "https://upload.wikimedia.org/wikipedia/commons/thumb/d/d4/Flag_of_Israel.svg/1200px-Flag_of_Israel.svg.png" }
        ];

        let selectedTeam = [];
        let coins = 150;
        let playerName = "שחקן"; // שם ברירת מחדל, ישתנה בהמשך
        const battles = [
            { name: "כיכר ירושלים", requiredAvg: 65, damage: 10, story: "האויב השתלט על הכיכר המרכזית, שחרר אותה!" },
            { name: "פארק המים", requiredAvg: 70, damage: 15, story: "חיילי האויב מתחבאים במגלשות, תקוף אותם!" },
            { name: "המרכז", requiredAvg: 75, damage: 20, story: "המרכז המסחרי נפל, הצילו את התושבים!" },
            { name: "שכונת האילנות", requiredAvg: 80, damage: 25, story: "מלכודות הוטמנו בשכונה, היזהר!" },
            { name: "כבוש את האגם", requiredAvg: 85, damage: 30, story: "האויב שולט באגם, תבחר את דרכך!" },
            { name: "יפה נוף", requiredAvg: 90, damage: 35, story: "קרב גובה קטלני, שלוט בהר!" },
            { name: "ביג בוס", requiredAvg: 92, damage: 40, story: "המנהיג הסופי מחכה, תביס אותו!" }
        ];

        const randomEvents = [
            { text: "מלכודת! הצוות שלך נפגע!", effect: () => selectedTeam.forEach(char => char.health -= 5) },
            { text: "תגבורת! מצאת אספקה!", effect: () => coins += 20 },
            { text: "מזל טוב! אויב נרדם!", effect: () => {} },
            { text: "אריאל שרביט התבלבלה בדרך!", effect: () => selectedTeam.filter(c => c.name === "אריאל שרביט").forEach(c => c.health -= 10) },
            { text: "מצאתם בירה בדרך!", effect: () => selectedTeam.forEach(char => char.health += 5) },
            { text: "רפי אלגרבלי התפוצץ!", effect: () => selectedTeam.filter(c => c.name === "רפי אלגרבלי").forEach(c => c.health = 0) }
        ];

        const postBattleMessages = [
            "אני לא יודע אם אוכל להחזיק מעמד בעוד קרב כזה, אני חייב לאונן מתישהו בקרוב",
            "אני חייב למצוץ משהו, אני לא יכול, אני חרמן מת, אני נורא מפחד מהקרב הבא",
            "אני חרמן ממש, נראה לי אני אכניס איזה מלפפון לתחת או שמישהו רגע יזיין אותי, אני לא יודע אם נחזור הביתה, הקרב האחרון היה קשה ואני מפחד מאוד, בבקשה שזה יגמר...",
            "טוב אני רגע מביא ביד, אני מצטער פה מולכם, זה יקרה, אין ברירה, לא נראה לי שנשרוד, תודה לכולם על הכל, הייתם חברים מדהימים"
        ];

        function showIntroPopup() {
            const popup = document.createElement("div");
            popup.className = "popup";
            popup.innerHTML = `
                <h2>מעלות תרשיחא בסכנה!</h2>
                <p>גורמים זרים חדרו לעיר ואתה היחיד שיכול לתקן את זה.<br>בעיר זמינים הצוות הבא, בחר 5 אנשים שישתתפו איתך.</p>
                <input type="text" id="player-name" placeholder="הכנס את שמך" style="margin: 10px; padding: 5px;">
                <button onclick="setPlayerName()">התחל</button>
            `;
            document.body.appendChild(popup);
        }

        function setPlayerName() {
            const nameInput = document.getElementById("player-name").value.trim();
            if (nameInput) {
                playerName = nameInput;
                document.querySelector(".popup").remove();
            } else {
                alert("אנא הכנס שם!");
            }
        }

        function displayCharacters() {
            const selectionDiv = document.getElementById("character-selection");
            characters.forEach(char => {
                const card = document.createElement("div");
                card.className = "character-card";
                card.innerHTML = `<img src="${char.image}"><div>${char.name}</div>`;
                card.onclick = () => toggleSelection(char, card);
                selectionDiv.appendChild(card);
            });
            showIntroPopup();
        }

        function toggleSelection(char, card) {
            const index = selectedTeam.findIndex(c => c.name === char.name);
            if (index !== -1) {
                selectedTeam.splice(index, 1);
                card.classList.remove("selected");
            } else if (selectedTeam.length < 5) {
                selectedTeam.push({ ...char, health: char.overall });
                card.classList.add("selected");
            }
            document.getElementById("confirm-team").disabled = selectedTeam.length !== 5;
        }

        function confirmTeam() {
            document.getElementById("character-selection").style.display = "none";
            document.getElementById("confirm-team").style.display = "none";
            const teamDisplay = document.getElementById("team-display");
            teamDisplay.style.display = "block";
            teamDisplay.innerHTML = `
                <h2>הצוות שלך:</h2>
                <p style="color: #ff0066; font-size: 1.2em;">שימו לב: ניתן לבחור מנהיג אחד, עד 3 חיילים וזונה אחת</p>
            `;

            let delay = 0;
            selectedTeam.forEach(char => {
                const stars = Math.floor(char.overall / 20);
                const card = document.createElement("div");
                card.className = "team-card";
                card.style.animationDelay = `${delay}s`;
                card.innerHTML = `
                    <img src="${char.image}" class="player-img">
                    <div class="name">${char.name}</div>
                    <div class="overall">Overall: ${char.overall}</div>
                    <div class="stars">${"★".repeat(stars)}</div>
                    <img class="flag" src="${char.flag}">
                    <select id="role-${char.name}">
                        <option value="">בחר תפקיד</option>
                        ${char.name !== "אריאל עין גל" && char.name !== "חיים מרקס" ? '<option value="מנהיג">מנהיג</option>' : ''}
                        <option value="חייל">חייל</option>
                        ${char.name !== "דביר ברקת" ? '<option value="זונה">זונה</option>' : ''}
                        ${char.name === "ליאב בן יעקב" ? '<option value="הגיי של הצוות">הגיי של הצוות</option>' : ''}
                    </select>
                `;
                teamDisplay.appendChild(card);
                delay += 0.5;
            });

            setTimeout(() => {
                const confirmRolesButton = document.createElement("button");
                confirmRolesButton.innerText = "התחל קרב";
                confirmRolesButton.onclick = confirmRoles;
                teamDisplay.appendChild(confirmRolesButton);
            }, delay * 1000 + 500);
        }

        function confirmRoles() {
            let leaderCount = 0, soldierCount = 0, whoreCount = 0;
            for (const char of selectedTeam) {
                const role = document.getElementById(`role-${char.name}`).value;

                if (!role) return alert("חובה לבחור תפקיד לכל חבר צוות!");
                if (role === "מנהיג") leaderCount++;
                if (role === "חייל") soldierCount++;
                if (role === "זונה") whoreCount++;

                if (char.name === "דביר ברקת" && role === "זונה") return showLosePopup(char);
                if (char.name === "אריאל שרביט" && role !== "חייל" && role !== "זונה") return alert("אריאל שרביט יכולה להיות רק חיילת או זונה!");
                if (char.name === "ליאב בן יעקב" && role !== "הגיי של הצוות") {
                    showLiavConfirmation(char, role);
                    return;
                }
            }

            if (leaderCount > 1) return alert("יכול להיות רק מנהיג אחד!");
            if (soldierCount > 3) return alert("יכולים להיות עד 3 חיילים!");
            if (whoreCount > 1) return alert("יכולה להיות רק זונה אחת!");

            selectedTeam.forEach(char => {
                const role = document.getElementById(`role-${char.name}`).value;
                char.role = role;
                if (role === "מנהיג") char.overall += 3;
                if (role === "חייל") char.overall += 1;
                if (role === "זונה") char.overall -= 2;
                char.health = char.overall;
            });

            startBattle(0);
        }

        function showLiavConfirmation(char, role) {
            const existingPopup = document.querySelector(".popup");
            if (existingPopup) existingPopup.remove();

            const popup = document.createElement("div");
            popup.className = "popup";
            popup.id = "liav-popup";
            popup.innerHTML = `
                <h3>האם אתה בטוח? ליאב יכול להיות הגיי של הצוות!</h3>
                <button onclick="confirmLiav('${char.name}', '${role}', true)">כן</button>
                <button onclick="confirmLiav('${char.name}', '${role}', false)">לא</button>
            `;
            document.body.appendChild(popup);
        }

        function confirmLiav(charName, role, confirm) {
            const popup = document.getElementById("liav-popup");
            if (popup) popup.remove();

            const selectElement = document.getElementById(`role-${charName}`);
            if (confirm) {
                selectElement.value = role;
            } else {
                selectElement.value = "הגיי של הצוות";
            }
            confirmRoles();
        }

        function showLosePopup(char) {
            const popup = document.createElement("div");
            popup.className = "popup";
            popup.innerHTML = `
                <h3>הפסדת!</h3>
                <p>דביר ברקת לא יכול להיות זונה והפרטים שלך נשלחו לדביר ברקת.</p>
                <img src="${char.image}">
            `;
            document.body.appendChild(popup);
        }

        function startBattle(battleIndex) {
            const battleDisplay = document.getElementById("battle-display");
            battleDisplay.style.display = "block";
            const teamDisplay = document.getElementById("team-display");
            teamDisplay.style.display = "none";
            const battle = battles[battleIndex];
            let aliveTeam = selectedTeam.filter(char => char.health > 0);

            if (battleIndex === 4) { // "כבוש את האגם"
                battleDisplay.innerHTML = `
                    <h2>${battle.name}</h2>
                    <p>${battle.story}</p>
                    <p>למי מהבאים אתה מוכן למצוץ?</p>
                    <select id="suck-choice">
                        ${characters.filter(c => c.name !== "אריאל שרביט").map(c => `<option value="${c.name}">${c.name}</option>`).join('')}
                    </select>
                    <button onclick="confirmSuckChoice(${battleIndex})">אשר</button>
                    <button onclick="fightZamira(${battleIndex})">להילחם בזמירה קחלר (Overall: 85, Health: 100)</button>
                `;
            } else {
                battleDisplay.innerHTML = `
                    <h2>מלחמה: ${battle.name}</h2>
                    <p>${battle.story}</p>
                    <p>דירוג ממוצע נדרש: ${battle.requiredAvg}</p>
                    <p>דירוג ממוצע שלך: ${(aliveTeam.reduce((sum, char) => sum + char.overall, 0) / aliveTeam.length || 0).toFixed(2)}</p>
                    <div class="battle-text">הצוות שלך מתכונן לתקוף...</div>
                    <button onclick="fightBattle(${battleIndex})">תקוף</button>
                `;
            }
        }

        function confirmSuckChoice(battleIndex) {
            const chosenName = document.getElementById("suck-choice").value;
            const popup = document.createElement("div");
            popup.className = "popup fancy";
            popup.innerHTML = `
                <h3>בחירה מרשימה!</h3>
                <p>אני ${playerName} בחרתי את ${chosenName} בתור בן אדם שאשמח למצוץ לו :)</p>
                <button onclick="this.parentElement.remove(); fightBattle(${battleIndex})">המשך לקרב</button>
            `;
            document.body.appendChild(popup);
        }

        function fightZamira(battleIndex) {
            const battleDisplay = document.getElementById("battle-display");
            let aliveTeam = selectedTeam.filter(char => char.health > 0);
            let zamiraHealth = 100;
            battleDisplay.innerHTML = `
                <h2>קרב נגד זמירה קחלר</h2>
                <p>Overall: 85 | Health: ${zamiraHealth}</p>
                <div class="battle-text">הצוות שלך תוקף את זמירה!</div>
            `;
            setTimeout(() => {
                const teamDamage = aliveTeam.reduce((sum, char) => sum + char.overall, 0) / 2;
                zamiraHealth = Math.max(0, zamiraHealth - teamDamage);
                aliveTeam.forEach(char => char.health = Math.max(0, char.health - 20));
                if (zamiraHealth <= 0) {
                    battleDisplay.innerHTML = `<p>ניצחת את זמירה קחלר!</p>`;
                    coins += 50;
                    setTimeout(() => displayTeamStatus(battleIndex), 2000);
                } else if (aliveTeam.every(char => char.health <= 0)) {
                    battleDisplay.innerHTML = `<p>זמירה קחלר ניצחה אותך!</p>`;
                } else {
                    battleDisplay.innerHTML = `
                        <h2>קרב נגד זמירה קחלר</h2>
                        <p>Health: ${zamiraHealth}</p>
                        <button onclick="fightZamira(${battleIndex})">המשך לתקוף</button>
                    `;
                }
            }, 2000);
        }

        function fightBattle(battleIndex) {
            const battle = battles[battleIndex];
            let aliveTeam = selectedTeam.filter(char => char.health > 0);
            const avg = aliveTeam.reduce((sum, char) => sum + char.overall, 0) / aliveTeam.length || 0;
            const battleDisplay = document.getElementById("battle-display");

            if (battleIndex === 2) {
                const traitors = aliveTeam.filter(char => char.name === "ליאב בן יעקב" || char.name === "עמית לסרי");
                if (traitors.length > 0) {
                    traitors.forEach(traitor => {
                        showTraitorPopup(traitor);
                        selectedTeam = selectedTeam.filter(char => char.name !== traitor.name);
                    });
                    setTimeout(() => {
                        document.querySelectorAll(".popup").forEach(popup => popup.remove());
                        aliveTeam = selectedTeam.filter(char => char.health > 0);
                        displayTeamStatus(battleIndex);
                    }, 3000);
                    return;
                }
            }

            battleDisplay.innerHTML = `<h2>מלחמה: ${battle.name}</h2><div class="battle-text">הצוות שלך תוקף את ${battle.name}!</div>`;
            setTimeout(() => {
                if (avg >= battle.requiredAvg) {
                    aliveTeam.forEach(char => {
                        char.health = Math.max(0, char.health - battle.damage);
                    });

                    if (Math.random() < 0.2 && aliveTeam.some(c => c.name === "דביר ברקת" && c.health > 0)) {
                        battleDisplay.innerHTML += `<p>דביר ברקת השתמש ב'צליפה מדויקת' וגרם 30 נזק נוסף לאויב!</p>`;
                        aliveTeam.forEach(char => char.health += 5); // בונוס קטן לבריאות כפרס
                    }

                    if (Math.random() < 0.3) {
                        const event = randomEvents[Math.floor(Math.random() * randomEvents.length)];
                        battleDisplay.innerHTML += `<p>${event.text}</p>`;
                        event.effect();
                    }

                    displayTeamStatus(battleIndex);
                    if (battleIndex < 4) showPostBattleMessage(battleIndex);
                } else {
                    battleDisplay.innerHTML = `
                        <h2>מלחמה: ${battle.name}</h2>
                        <p>הפסדת! הדירוג שלך נמוך מדי (${avg.toFixed(2)} < ${battle.requiredAvg}).</p>
                    `;
                }
            }, 2000);
        }

        function showTraitorPopup(traitor) {
            traitor.flag = "https://upload.wikimedia.org/wikipedia/commons/thumb/c/ca/Flag_of_Iran.svg/1200px-Flag_of_Iran.svg.png";
            const popup = document.createElement("div");
            popup.className = "popup";
            popup.innerHTML = `
                <img src="${traitor.image}">
                <h3>${traitor.name} היה סוכן זר והוא עוזר ליריב!</h3>
                <img src="${traitor.flag}" style="width: 40px;">
            `;
            document.body.appendChild(popup);
        }

        function displayTeamStatus(battleIndex) {
            const battleDisplay = document.getElementById("battle-display");
            const aliveTeam = selectedTeam.filter(char => char.health > 0);
            battleDisplay.innerHTML = `
                <h2>מלחמה: ${battles[battleIndex].name}</h2>
                <p>דירוג ממוצע נדרש: ${battles[battleIndex].requiredAvg}</p>
                <p>דירוג ממוצע שלך: ${(aliveTeam.reduce((sum, char) => sum + char.overall, 0) / aliveTeam.length || 0).toFixed(2)}</p>
                <p>מטבעות: ${coins}</p>
                <h3>מצב הצוות:</h3>
            `;
            selectedTeam.forEach(char => {
                const healthPercent = (char.health / char.overall) * 100;
                battleDisplay.innerHTML += `
                    <div>
                        ${char.name} (${char.role}) - חיים: ${char.health}/${char.overall}
                        <div class="health-bar"><div class="health-bar-fill" style="width: ${healthPercent}%"></div></div>
                        ${char.health > 0 && char.health < char.overall ? `<button onclick="heal('${char.name}', ${battleIndex})">רפא (10 מטבעות)</button>` : ""}
                    </div>`;
            });

            if (aliveTeam.length === 0) {
                battleDisplay.innerHTML += "<p>הפסדת! כל הצוות שלך מת.</p>";
            } else if (battleIndex < battles.length - 1) {
                battleDisplay.innerHTML += `<button onclick="startBattle(${battleIndex + 1})">המשך לשלב הבא</button>`;
            } else {
                battleDisplay.innerHTML += "<p>ניצחת את הביג בוס! סיימת את המשחק!</p>";
            }
        }

        function heal(charName, battleIndex) {
            if (coins >= 10) {
                const char = selectedTeam.find(c => c.name === charName);
                if (char && char.health > 0 && char.health < char.overall) {
                    char.health = Math.min(char.overall, char.health + 10);
                    coins -= 10;
                    displayTeamStatus(battleIndex);
                }
            } else {
                alert("אין מספיק מטבעות!");
            }
        }

        function showPostBattleMessage(battleIndex) {
            const aliveTeam = selectedTeam.filter(char => char.health > 0 && char.name !== "דביר ברקת");
            if (aliveTeam.length === 0) return;

            const randomChar = aliveTeam[Math.floor(Math.random() * aliveTeam.length)];
            const message = postBattleMessages[battleIndex];

            const popup = document.createElement("div");
            popup.className = "message-popup";
            popup.innerHTML = `
                <img src="${randomChar.image}">
                <p><strong>${randomChar.name}:</strong> ${message}</p>
                <button onclick="this.parentElement.remove()">סגור</button>
            `;
            document.body.appendChild(popup);

            setTimeout(() => {
                if (popup && document.body.contains(popup)) {
                    popup.remove();
                }
            }, 5000);
        }

        document.getElementById("confirm-team").onclick = confirmTeam;
        displayCharacters();
    </script>
</body>
</html>
