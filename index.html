<!DOCTYPE html>
<html lang="he">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>מלחמת הבלאקיף</title>
    <link href="https://fonts.googleapis.com/css2?family=Rubik:wght@400;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Rubik', sans-serif;
            background: linear-gradient(135deg, #1a1a1a, #2b2b2b);
            color: #e0e1dd;
            direction: rtl;
            margin: 0;
            padding: 20px;
            min-height: 100vh;
            overflow-x: hidden;
            animation: glowBackground 5s infinite alternate;
        }

        @keyframes glowBackground {
            0% { background: linear-gradient(135deg, #1a1a1a, #2b2b2b); }
            100% { background: linear-gradient(135deg, #2b2b2b, #3c3c3c); }
        }

        h1 {
            color: #ffcc00;
            text-shadow: 0 0 15px #ffcc00;
            font-size: 3em;
            text-align: center;
            margin: 10px 0;
        }

        h2 {
            color: #ff0066;
            text-shadow: 0 0 10px #ff0066;
            font-size: 2em;
            margin: 10px 0;
        }

        .container {
            display: flex;
            flex-wrap: wrap;
            justify-content: center;
            gap: 15px;
            padding: 10px;
        }

        .card {
            background: rgba(255, 255, 255, 0.05);
            border: 2px solid #ffcc00;
            border-radius: 10px;
            box-shadow: 0 0 15px rgba(255, 204, 0, 0.5);
            padding: 15px;
            width: 200px;
            text-align: center;
            transition: transform 0.3s, box-shadow 0.3s;
            cursor: pointer;
        }

        .card:hover {
            transform: scale(1.05);
            box-shadow: 0 0 25px #ff0066;
        }

        .card.selected {
            border-color: #ff0066;
            box-shadow: 0 0 20px #ff0066;
        }

        .card img {
            width: 120px;
            height: 120px;
            border-radius: 8px;
            object-fit: cover;
            border: 1px solid #ffcc00;
        }

        button {
            padding: 12px 25px;
            font-size: 16px;
            background: linear-gradient(45deg, #ff0066, #ffcc00);
            color: #fff;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            box-shadow: 0 0 15px #ff0066;
            transition: transform 0.3s, box-shadow 0.3s;
            margin: 5px;
        }

        button:hover {
            transform: scale(1.05);
            box-shadow: 0 0 25px #ffcc00;
        }

        button:disabled {
            background: #555;
            box-shadow: none;
            cursor: not-allowed;
        }

        select {
            padding: 8px;
            font-size: 14px;
            background: rgba(255, 255, 255, 0.1);
            color: #e0e1dd;
            border: 1px solid #ffcc00;
            border-radius: 5px;
            margin: 5px 0;
        }

        .popup {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: linear-gradient(135deg, #2b2b2b, #3c3c3c);
            border: 3px solid #ff0066;
            padding: 20px;
            border-radius: 15px;
            box-shadow: 0 0 40px #ff0066;
            z-index: 1000;
            width: 90%;
            max-width: 700px;
            max-height: 80vh;
            overflow-y: auto;
            animation: popupGlow 2s infinite alternate;
        }

        @keyframes popupGlow {
            0% { box-shadow: 0 0 40px #ff0066; }
            100% { box-shadow: 0 0 60px #ffcc00; }
        }

        .popup-content {
            display: flex;
            flex-direction: column;
            gap: 15px;
        }

        .battle-screen {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 20px;
            background: rgba(0, 0, 0, 0.8);
            padding: 20px;
            border-radius: 15px;
            box-shadow: 0 0 30px #ff0066;
        }

        .team-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 15px;
            width: 100%;
            max-width: 800px;
        }

        .health-bar {
            width: 100%;
            background: #333;
            height: 10px;
            border-radius: 5px;
            margin: 5px 0;
        }

        .health-bar-fill {
            height: 100%;
            background: #ffcc00;
            transition: width 0.5s ease;
            border-radius: 5px;
        }

        @media (max-width: 600px) {
            h1 { font-size: 2em; }
            h2 { font-size: 1.5em; }
            .card { width: 140px; }
            .card img { width: 80px; height: 80px; }
            button { font-size: 14px; padding: 8px 15px; }
            .popup { width: 95%; padding: 15px; }
        }
    </style>
</head>
<body>
    <h1>מלחמת הבלאקיף</h1>
    <div id="main-menu" class="container"></div>
    <div id="character-selection" class="container" style="display: none;"></div>
    <div id="team-display" class="container" style="display: none;"></div>
    <div id="battle-display" class="battle-screen" style="display: none;"></div>
    <div id="city-management" class="container" style="display: none;"></div>

    <script>
        const weapons = {
            "גלוק": { cost: 1000, bonus: 1, image: "https://example.com/glock.png" },
            "עוזי": { cost: 5000, bonus: 2, image: "https://example.com/uzi.png" },
            "M16": { cost: 15000, bonus: 3, image: "https://example.com/m16.png" },
            "M4": { cost: 30000, bonus: 4, image: "https://example.com/m4.png" },
            "RPG": { cost: 50000, bonus: 5, image: "https://static.wikia.nocookie.net/maxpayne/images/4/40/Rpg.png" }
        };

        const characters = [
            { name: "אור דהן", overall: 79, image: "https://i.postimg.cc/13r31pJG/IMG-5054.jpg", flag: "https://upload.wikimedia.org/wikipedia/commons/thumb/d/d4/Flag_of_Israel.svg/1200px-Flag_of_Israel.svg.png", value: Math.round(80000 + ((79 - 57) / (96 - 57)) * (36000000 - 80000)), attack: 75, defense: 70, fatPercentage: 18, report: "ביצועים סבירים", weapon: "גלוק", trained: false },
            { name: "יוסף קחלר", overall: 88, image: "https://i.postimg.cc/KYcvGRHd/IMG-4721-2.jpg", flag: "https://upload.wikimedia.org/wikipedia/commons/thumb/f/f6/Flag_of_Iraq.svg/1200px-Flag_of_Iraq.svg.png", value: Math.round(80000 + ((88 - 57) / (96 - 57)) * (36000000 - 80000)), attack: 90, defense: 85, fatPercentage: 12, report: "לוחם מצוין", weapon: "גלוק", trained: false },
            { name: "עמית לסרי", overall: 90, image: "https://i.postimg.cc/Y2T962vW/IMG-5056.jpg", flag: "https://upload.wikimedia.org/wikipedia/commons/thumb/d/d4/Flag_of_Israel.svg/1200px-Flag_of_Israel.svg.png", value: Math.round(80000 + ((90 - 57) / (96 - 57)) * (36000000 - 80000)), attack: 92, defense: 88, fatPercentage: 10, report: "כישרון טבעי", weapon: "גלוק", trained: false },
            { name: "איציק מור יוסף", overall: 82, image: "https://i.postimg.cc/SQnRYYx4/IMG-5057.jpg", flag: "https://upload.wikimedia.org/wikipedia/commons/thumb/d/d4/Flag_of_Israel.svg/1200px-Flag_of_Israel.svg.png", value: Math.round(80000 + ((82 - 57) / (96 - 57)) * (36000000 - 80000)), attack: 80, defense: 78, fatPercentage: 15, report: "ביצועים טובים", weapon: "גלוק", trained: false },
            { name: "איתי אוחנה", overall: 90, image: "https://i.postimg.cc/DwTwNCdf/IMG-5058.jpg", flag: "https://upload.wikimedia.org/wikipedia/commons/thumb/d/d4/Flag_of_Israel.svg/1200px-Flag_of_Israel.svg.png", value: Math.round(80000 + ((90 - 57) / (96 - 57)) * (36000000 - 80000)), attack: 93, defense: 87, fatPercentage: 9, report: "חייל עילית", weapon: "גלוק", trained: false },
            { name: "ג׳ורדן בוחבוט", overall: 86, image: "https://i.postimg.cc/zvbsDr5m/IMG-5059.jpg", flag: "https://upload.wikimedia.org/wikipedia/commons/thumb/d/d4/Flag_of_Israel.svg/1200px-Flag_of_Israel.svg.png", value: Math.round(80000 + ((86 - 57) / (96 - 57)) * (36000000 - 80000)), attack: 88, defense: 82, fatPercentage: 13, report: "לוחם אמין", weapon: "גלוק", trained: false },
            { name: "דביר אוחנה", overall: 92, image: "https://i.postimg.cc/J0f9G24s/IMG-5060.jpg", flag: "https://upload.wikimedia.org/wikipedia/commons/thumb/d/d4/Flag_of_Israel.svg/1200px-Flag_of_Israel.svg.png", value: Math.round(80000 + ((92 - 57) / (96 - 57)) * (36000000 - 80000)), attack: 95, defense: 90, fatPercentage: 8, report: "כוכב עליון", weapon: "גלוק", trained: false },
            { name: "דור אביכזר", overall: 80, image: "https://i.postimg.cc/vBNRdmJL/IMG-5061.jpg", flag: "https://upload.wikimedia.org/wikipedia/commons/thumb/d/d4/Flag_of_Israel.svg/1200px-Flag_of_Israel.svg.png", value: Math.round(80000 + ((80 - 57) / (96 - 57)) * (36000000 - 80000)), attack: 78, defense: 75, fatPercentage: 17, report: "ממוצע", weapon: "גלוק", trained: false },
            { name: "יוגב שבתאי", overall: 74, image: "https://i.postimg.cc/TYmPC8bH/IMG-5062.jpg", flag: "https://upload.wikimedia.org/wikipedia/commons/thumb/d/d4/Flag_of_Israel.svg/1200px-Flag_of_Israel.svg.png", value: Math.round(80000 + ((74 - 57) / (96 - 57)) * (36000000 - 80000)), attack: 70, defense: 68, fatPercentage: 22, report: "חלש יחסית", weapon: "גלוק", trained: false },
            { name: "ליאב בן יעקב", overall: 83, image: "https://i.postimg.cc/Sss059vx/IMG-5063.jpg", flag: "https://upload.wikimedia.org/wikipedia/commons/thumb/d/d4/Flag_of_Israel.svg/1200px-Flag_of_Israel.svg.png", value: Math.round(80000 + ((83 - 57) / (96 - 57)) * (36000000 - 80000)), attack: 82, defense: 80, fatPercentage: 14, report: "ביצועים טובים", weapon: "גלוק", trained: false },
            { name: "אריאל עין גל", overall: 58, image: "https://i.postimg.cc/k5w3fsw-H/IMG-5064.jpg", flag: "https://upload.wikimedia.org/wikipedia/commons/thumb/d/d4/Flag_of_Israel.svg/1200px-Flag_of_Israel.svg.png", value: Math.round(80000 + ((58 - 57) / (96 - 57)) * (36000000 - 80000)), attack: 55, defense: 50, fatPercentage: 30, report: "חלש מאוד", weapon: "גלוק", trained: false },
            { name: "מיכה גורלובסקי", overall: 85, image: "https://i.postimg.cc/jjRYHm6N/IMG-5065.jpg", flag: "https://upload.wikimedia.org/wikipedia/commons/thumb/d/d4/Flag_of_Israel.svg/1200px-Flag_of_Israel.svg.png", value: Math.round(80000 + ((85 - 57) / (96 - 57)) * (36000000 - 80000)), attack: 87, defense: 83, fatPercentage: 11, report: "לוחם חזק", weapon: "גלוק", trained: false },
            { name: "קורן בן משה", overall: 89, image: "https://i.postimg.cc/wjXdsgNg/IMG-5066.jpg", flag: "https://upload.wikimedia.org/wikipedia/commons/thumb/d/d4/Flag_of_Israel.svg/1200px-Flag_of_Israel.svg.png", value: Math.round(80000 + ((89 - 57) / (96 - 57)) * (36000000 - 80000)), attack: 91, defense: 86, fatPercentage: 10, report: "מצוין", weapon: "גלוק", trained: false },
            { name: "נתנאל יוסילביץ׳", overall: 82, image: "https://i.postimg.cc/wMndDBFT/IMG-5068.jpg", flag: "https://upload.wikimedia.org/wikipedia/commons/thumb/d/d4/Flag_of_Israel.svg/1200px-Flag_of_Israel.svg.png", value: Math.round(80000 + ((82 - 57) / (96 - 57)) * (36000000 - 80000)), attack: 80, defense: 79, fatPercentage: 16, report: "סביר", weapon: "גלוק", trained: false },
            { name: "חיים מרקס", overall: 66, image: "https://i.postimg.cc/MHnScB7F/IMG-5069.jpg", flag: "https://upload.wikimedia.org/wikipedia/commons/thumb/a/a4/Flag_of_the_United_States.svg/1200px-Flag_of_the_United_States.svg.png", value: Math.round(80000 + ((66 - 57) / (96 - 57)) * (36000000 - 80000)), attack: 65, defense: 60, fatPercentage: 25, report: "ביצועים נמוכים", weapon: "גלוק", trained: false },
            { name: "רפי אלגרבלי", overall: 71, image: "https://i.postimg.cc/9MFVhKrV/IMG-5070.jpg", flag: "https://upload.wikimedia.org/wikipedia/commons/thumb/0/00/Flag_of_Palestine.svg/1200px-Flag_of_Palestine.svg.png", value: Math.round(80000 + ((71 - 57) / (96 - 57)) * (36000000 - 80000)), attack: 68, defense: 66, fatPercentage: 23, report: "חלש", weapon: "גלוק", trained: false },
            { name: "יעקב שוורץ", overall: 88, image: "https://i.postimg.cc/nzRxc2Dm/IMG-5071.jpg", flag: "https://upload.wikimedia.org/wikipedia/commons/thumb/d/d4/Flag_of_Israel.svg/1200px-Flag_of_Israel.svg.png", value: Math.round(80000 + ((88 - 57) / (96 - 57)) * (36000000 - 80000)), attack: 89, defense: 85, fatPercentage: 12, report: "לוחם מעולה", weapon: "גלוק", trained: false },
            { name: "אריאל שרביט", overall: 57, image: "https://i.postimg.cc/TPcGBf2C/IMG-5072.jpg", flag: "https://upload.wikimedia.org/wikipedia/commons/thumb/d/d4/Flag_of_Israel.svg/1200px-Flag_of_Israel.svg.png", value: 80000, attack: 50, defense: 45, fatPercentage: 32, report: "חלשה ביותר", weapon: "גלוק", trained: false },
            { name: "דביר ברקת", overall: 96, image: "https://www.qube.co.il/images/ency/bands/DvirBareket.jpg", flag: "https://upload.wikimedia.org/wikipedia/commons/thumb/d/d4/Flag_of_Israel.svg/1200px-Flag_of_Israel.svg.png", value: 36000000, attack: 99, defense: 98, fatPercentage: 5, report: "מושלם", weapon: "גלוק", trained: false }
        ];

        let selectedTeam = [];
        let coins = 150;
        let teamBudget = 15000000;
        let completedBattles = [];
        let lastBattleName = "";
        let cityBudget = 5000000;
        let cityPopulation = 22000;
        let cityName = "מעלות תרשיחא";
        let cityNeighborhoods = ["יפה נוף", "סביונים", "מרכז העיר", "שכונת רבין", "גבעת הזיתים", "אילנות", "סביונים"];
        let prostitutes = [];
        let buildings = [
            { name: "הבית של ג׳ורדן", value: 4000000, sold: false },
            { name: "הבית של איתי אוחנה", value: 3000000, sold: false },
            { name: "הבית של יוסף קחלר", value: 1500000, sold: false },
            { name: "הבית של יוגב שבתאי", value: 200000, sold: false },
            { name: "הבית של דביר אוחנה", value: 450000, sold: false }
        ];
        let cityUpgrades = { newNeighborhood: false, airport: false, hotel: false };
        let bigBossDefeated = false;
        let assignedJobs = {};

        const battles = [
            { name: "כיכר ירושלים", requiredAvg: 65, damage: 10, story: "האויב השתלט על הכיכר המרכזית!" },
            { name: "פארק המים", requiredAvg: 70, damage: 15, story: "חיילי האויב מתחבאים במגלשות!" },
            { name: "המרכז", requiredAvg: 75, damage: 20, story: "המרכז המסחרי נפל!" },
            { name: "שכונת האילנות", requiredAvg: 80, damage: 25, story: "מלכודות הוטמנו בשכונה!" },
            { name: "שכונת סביונים", requiredAvg: 85, damage: 30, story: "האויב בנה בסיס בסביונים!" },
            { name: "יפה נוף", requiredAvg: 90, damage: 35, story: "קרב גובה קטלני!" },
            { name: "ביג בוס", requiredAvg: 92, damage: 40, story: "המנהיג הסופי מחכה!" }
        ];

        const cityJobs = {
            "ראש העיר": 200000,
            "סמנכ״ל": 50000,
            "עובד בזבל": 6000,
            "נהג משאית": 8000,
            "מזכיר/ה": 7000,
            "מנהל בית ספר": 25000,
            "מנהל אבטחה": 10000,
            "שומר בית ספר": 7000,
            "עובד במפעל עטיפית": 5500,
            "עובד בפסקל": 5500,
            "עובד ביילו": 5000,
            "עובד במים": 7000,
            "עובד בחשמל": 7000,
            "מנהל האגם": 20000
        };

        const prostitutesList = ["לאה אוחנה", "אמא של רפי", "זמירה קחלר", "ורד עין גל"];

        const funnyMessages = [
            "אני חייב לאונן עכשיו, תכסה אותי!",
            "האויב זרק עליי גרב מסריחה!",
            "מישהו ראה את הסנדוויץ' שלי?",
            "אני עייף, אפשר הפסקת קפה?"
        ];

        function showMainMenu() {
            const mainMenu = document.getElementById("main-menu");
            mainMenu.style.display = "flex";
            mainMenu.innerHTML = `
                <button onclick="displayCharacters()">התחל משחק</button>
                ${bigBossDefeated ? `<button onclick="showCityManagement()">ניהול ${cityName}</button>` : ""}
            `;
            hideAllExcept("main-menu");
        }

        function hideAllExcept(activeId) {
            ["main-menu", "character-selection", "team-display", "battle-display", "city-management"].forEach(id => {
                document.getElementById(id).style.display = id === activeId ? "flex" : "none";
            });
        }

        function displayCharacters() {
            const selectionDiv = document.getElementById("character-selection");
            selectionDiv.style.display = "flex";
            selectionDiv.innerHTML = "";
            characters.forEach(char => {
                const card = document.createElement("div");
                card.className = "card";
                card.innerHTML = `<img src="${char.image}" alt="${char.name}"><div>${char.name}</div>`;
                card.onclick = () => toggleSelection(char, card);
                selectionDiv.appendChild(card);
            });
            const confirmButton = document.createElement("button");
            confirmButton.id = "confirm-team";
            confirmButton.innerText = "אשר צוות";
            confirmButton.disabled = true;
            confirmButton.onclick = confirmTeam;
            selectionDiv.appendChild(confirmButton);
            hideAllExcept("character-selection");
        }

        function toggleSelection(char, card) {
            const index = selectedTeam.findIndex(c => c.name === char.name);
            if (index !== -1) {
                selectedTeam.splice(index, 1);
                card.classList.remove("selected");
            } else if (selectedTeam.length < 5) {
                selectedTeam.push({ ...char, health: char.overall });
                card.classList.add("selected");
            }
            document.getElementById("confirm-team").disabled = selectedTeam.length !== 5;
        }

        function confirmTeam() {
            const teamDisplay = document.getElementById("team-display");
            teamDisplay.style.display = "flex";
            teamDisplay.innerHTML = `<h2>הצוות שלך:</h2>`;
            selectedTeam.forEach(char => {
                const card = document.createElement("div");
                card.className = "card";
                card.innerHTML = `
                    <img src="${char.image}" alt="${char.name}">
                    <div>${char.name}</div>
                    <select id="role-${char.name}">
                        <option value="">בחר תפקיד</option>
                        ${char.name !== "אריאל עין גל" && char.name !== "חיים מרקס" ? '<option value="מנהיג">מנהיג</option>' : ''}
                        <option value="חייל">חייל</option>
                        ${char.name !== "דביר ברקת" ? '<option value="זונה">זונה</option>' : ''}
                    </select>
                `;
                teamDisplay.appendChild(card);
            });
            teamDisplay.innerHTML += `
                <button onclick="confirmRoles()">אשר תפקידים</button>
                <button onclick="assignRandomRoles()">בחר תפקידים אוטומטית</button>
                <button onclick="showMainMenu()">חזור לתפריט ראשי</button>
            `;
            hideAllExcept("team-display");
        }

        function assignRandomRoles() {
            let available = [...selectedTeam];
            selectedTeam.forEach(char => char.role = "");

            // מנהיג אחד
            let leaderCandidates = available.filter(c => c.name !== "אריאל עין גל" && c.name !== "חיים מרקס");
            const leader = leaderCandidates[Math.floor(Math.random() * leaderCandidates.length)];
            leader.role = "מנהיג";
            available = available.filter(c => c.name !== leader.name);

            // זונה אחת
            let whoreCandidates = available.filter(c => c.name !== "דביר ברקת");
            const whore = whoreCandidates[Math.floor(Math.random() * whoreCandidates.length)];
            whore.role = "זונה";
            available = available.filter(c => c.name !== whore.name);

            // עד 3 חיילים
            for (let i = 0; i < Math.min(3, available.length); i++) {
                available[i].role = "חייל";
            }

            confirmRoles();
        }

        function confirmRoles() {
            let leaderCount = 0, soldierCount = 0, whoreCount = 0;
            for (const char of selectedTeam) {
                const role = char.role || document.getElementById(`role-${char.name}`).value;
                if (!role) return alert("חובה לבחור תפקיד לכל חבר צוות!");
                if (role === "מנהיג") leaderCount++;
                if (role === "חייל") soldierCount++;
                if (role === "זונה") whoreCount++;
                if (char.name === "דביר ברקת" && role === "זונה") return showLosePopup(char);
                if (char.name === "אריאל שרביט" && role !== "חייל" && role !== "זונה") return alert("אריאל שרביט יכולה להיות רק חיילת או זונה!");
            }
            if (leaderCount > 1) return alert("יכול להיות רק מנהיג אחד!");
            if (soldierCount > 3) return alert("יכולים להיות עד 3 חיילים!");
            if (whoreCount > 1) return alert("יכולה להיות רק זונה אחת!");

            selectedTeam.forEach(char => {
                const role = char.role || document.getElementById(`role-${char.name}`).value;
                char.role = role;
                if (role === "מנהיג") char.overall += 3;
                if (role === "חייל") char.overall += 1;
                if (role === "זונה") char.overall -= 2;
                char.health = char.overall;
            });
            startBattle(0);
        }

        function showLosePopup(char) {
            const popup = document.createElement("div");
            popup.className = "popup";
            popup.innerHTML = `
                <div class="popup-content">
                    <h3>הפסדת!</h3>
                    <p>דביר ברקת לא יכול להיות זונה!</p>
                    <img src="${char.image}" alt="${char.name}">
                    <button onclick="this.parentElement.parentElement.remove(); showMainMenu()">חזור לתפריט ראשי</button>
                </div>
            `;
            document.body.appendChild(popup);
        }

        function startBattle(battleIndex) {
            const battleDisplay = document.getElementById("battle-display");
            battleDisplay.style.display = "flex";
            const battle = battles[battleIndex];
            battleDisplay.innerHTML = `
                <h2>קרב: ${battle.name}</h2>
                <p>${battle.story}</p>
                <h3>הצוות שלך:</h3>
                <div class="team-grid">
                    ${selectedTeam.map(char => `
                        <div class="card">
                            <img src="${char.image}" alt="${char.name}">
                            <div>${char.name}</div>
                            <div>תפקיד: ${char.role}</div>
                            <div>חיים: ${char.health}/${char.overall}</div>
                            <div class="health-bar"><div class="health-bar-fill" style="width: ${(char.health / char.overall) * 100}%"></div></div>
                        </div>
                    `).join('')}
                </div>
                <button onclick="fightBattle(${battleIndex})">להילחם!</button>
                <button onclick="showTeamManagement(${battleIndex})">ניהול צוות</button>
                <button onclick="showMainMenu()">חזור לתפריט ראשי</button>
            `;
            hideAllExcept("battle-display");
            if (Math.random() < 0.2) showFunnyPopup();
        }

        function showFunnyPopup() {
            const char = selectedTeam[Math.floor(Math.random() * selectedTeam.length)];
            const message = funnyMessages[Math.floor(Math.random() * funnyMessages.length)];
            const popup = document.createElement("div");
            popup.className = "popup";
            popup.innerHTML = `
                <div class="popup-content">
                    <h3>הודעה מ${char.name}</h3>
                    <p>"${message}"</p>
                    <img src="${char.image}" alt="${char.name}">
                    <button onclick="this.parentElement.parentElement.remove()">סגור</button>
                </div>
            `;
            document.body.appendChild(popup);
        }

        function fightBattle(battleIndex) {
            const battle = battles[battleIndex];
            let aliveTeam = selectedTeam.filter(char => char.health > 0);
            const avg = aliveTeam.reduce((sum, char) => sum + char.overall, 0) / aliveTeam.length || 0;
            const battleDisplay = document.getElementById("battle-display");
            lastBattleName = battle.name;

            if (avg >= battle.requiredAvg) {
                aliveTeam.forEach(char => {
                    if (char.weapon !== "RPG") char.health = Math.max(0, char.health - battle.damage);
                });
                if (battleIndex === battles.length - 1) bigBossDefeated = true;
                displayTeamStatus(battleIndex);
            } else {
                battleDisplay.innerHTML = `
                    <h2>קרב: ${battle.name}</h2>
                    <p>הפסדת! הדירוג שלך נמוך מדי (${avg.toFixed(2)} < ${battle.requiredAvg}).</p>
                    <button onclick="showTeamManagement(${battleIndex})">ניהול צוות</button>
                    <button onclick="showMainMenu()">חזור לתפריט ראשי</button>
                `;
            }
        }

        function displayTeamStatus(battleIndex) {
            const battleDisplay = document.getElementById("battle-display");
            const aliveTeam = selectedTeam.filter(char => char.health > 0);
            battleDisplay.innerHTML = `
                <h2>מצב הקבוצה - ${battles[battleIndex].name}</h2>
                <p>דירוג ממוצע: ${(aliveTeam.reduce((sum, char) => sum + char.overall, 0) / aliveTeam.length || 0).toFixed(2)}</p>
                <p>מטבעות: ${coins} | תקציב: ${teamBudget.toLocaleString()} €</p>
                <div class="team-grid">
                    ${selectedTeam.map(char => `
                        <div class="card">
                            <img src="${char.image}" alt="${char.name}">
                            <div>${char.name} (${char.role})</div>
                            <div>חיים: ${char.health}/${char.overall}</div>
                            <div class="health-bar"><div class="health-bar-fill" style="width: ${(char.health / char.overall) * 100}%"></div></div>
                        </div>
                    `).join('')}
                </div>
                <button onclick="${battleIndex < battles.length - 1 ? `startBattle(${battleIndex + 1})` : `showCityManagement()`}">${battleIndex < battles.length - 1 ? "קרב הבא" : "ניהול עיר"}</button>
                <button onclick="showTransferWindow(${battleIndex})">חלון העברות</button>
                <button onclick="showTeamManagement(${battleIndex})">ניהול צוות</button>
                <button onclick="showMainMenu()">חזור לתפריט ראשי</button>
            `;
        }

        function showTransferWindow(battleIndex) {
            const popup = document.createElement("div");
            popup.className = "popup";
            popup.innerHTML = `
                <div class="popup-content">
                    <h2>חלון העברות</h2>
                    <p>תקציב: ${teamBudget.toLocaleString()} €</p>
                    <h3>מכירת שחקנים</h3>
                    <div class="team-grid" id="sell-section"></div>
                    <h3>רכישת שחקנים</h3>
                    <div class="team-grid" id="buy-section"></div>
                    <button onclick="this.parentElement.parentElement.remove(); displayTeamStatus(${battleIndex})">סגור</button>
                </div>
            `;
            document.body.appendChild(popup);

            const sellSection = document.getElementById("sell-section");
            selectedTeam.forEach(char => {
                sellSection.innerHTML += `
                    <div class="card">
                        <img src="${char.image}" alt="${char.name}">
                        <div>${char.name}</div>
                        <div>שווי: ${char.value.toLocaleString()} €</div>
                        <button onclick="sellPlayer('${char.name}', ${battleIndex})">מכור</button>
                    </div>`;
            });

            const buySection = document.getElementById("buy-section");
            characters.filter(c => !selectedTeam.some(t => t.name === c.name)).forEach(char => {
                buySection.innerHTML += `
                    <div class="card">
                        <img src="${char.image}" alt="${char.name}">
                        <div>${char.name}</div>
                        <div>שווי: ${char.value.toLocaleString()} €</div>
                        <div>Overall: ${char.overall}</div>
                        <button onclick="buyPlayer('${char.name}', ${battleIndex})" ${teamBudget < char.value ? "disabled" : ""}>קנה</button>
                    </div>`;
            });
        }

        function sellPlayer(charName, battleIndex) {
            const char = selectedTeam.find(c => c.name === charName);
            teamBudget += char.value;
            selectedTeam = selectedTeam.filter(c => c.name !== charName);
            document.querySelector(".popup").remove();
            showTransferWindow(battleIndex);
        }

        function buyPlayer(charName, battleIndex) {
            const char = characters.find(c => c.name === charName);
            if (teamBudget >= char.value && selectedTeam.length < 5) {
                teamBudget -= char.value;
                selectedTeam.push({ ...char, health: char.overall });
                document.querySelector(".popup").remove();
                showTransferWindow(battleIndex);
            } else {
                alert(selectedTeam.length >= 5 ? "צוות מלא!" : "אין מספיק תקציב!");
            }
        }

        function showTeamManagement(battleIndex) {
            const popup = document.createElement("div");
            popup.className = "popup";
            popup.innerHTML = `
                <div class="popup-content">
                    <h2>ניהול צוות</h2>
                    <p>מטבעות: ${coins} | תקציב: ${teamBudget.toLocaleString()} €</p>
                    <h3>אימון וריפוי</h3>
                    <div class="team-grid" id="training-section"></div>
                    <h3>נשקים</h3>
                    <div class="team-grid" id="weapons-section"></div>
                    <button onclick="this.parentElement.parentElement.remove(); startBattle(${battleIndex})">חזור לקרב</button>
                    <button onclick="this.parentElement.parentElement.remove(); showMainMenu()">חזור לתפריט ראשי</button>
                </div>
            `;
            document.body.appendChild(popup);

            const trainingSection = document.getElementById("training-section");
            selectedTeam.forEach(char => {
                trainingSection.innerHTML += `
                    <div class="card">
                        <img src="${char.image}" alt="${char.name}">
                        <div>${char.name}</div>
                        <div>Overall: ${char.overall}</div>
                        <div>חיים: ${char.health}/${char.overall}</div>
                        <button onclick="trainPlayer('${char.name}', ${battleIndex})" ${char.trained || coins < 5 ? "disabled" : ""}>אמן (5 מטבעות)</button>
                        <button onclick="healPlayer('${char.name}', ${battleIndex})" ${char.health >= char.overall || coins < 10 ? "disabled" : ""}>רפא (10 מטבעות)</button>
                    </div>`;
            });

            const weaponsSection = document.getElementById("weapons-section");
            selectedTeam.forEach(char => {
                weaponsSection.innerHTML += `
                    <div class="card">
                        <img src="${char.image}" alt="${char.name}">
                        <div>${char.name}</div>
                        <div>נשק נוכחי: ${char.weapon} (+${weapons[char.weapon].bonus})</div>
                        <button onclick="sellWeapon('${char.name}', ${battleIndex})" ${char.weapon === "גלוק" ? "disabled" : ""}>מכור נשק</button>
                        <select onchange="buyWeapon('${char.name}', this.value, ${battleIndex})">
                            <option value="">בחר נשק חדש</option>
                            ${Object.keys(weapons).filter(w => (char.name !== "אריאל שרביט" || w === "גלוק") && (w !== "RPG" || char.name === "דביר ברקת")).map(w => `
                                <option value="${w}" ${teamBudget < weapons[w].cost || char.weapon === w ? "disabled" : ""}>${w} (${weapons[w].cost.toLocaleString()} €, +${weapons[w].bonus})</option>
                            `).join('')}
                        </select>
                    </div>`;
            });
        }

        function trainPlayer(charName, battleIndex) {
            const char = selectedTeam.find(c => c.name === charName);
            if (coins >= 5 && !char.trained) {
                coins -= 5;
                char.overall += 3;
                char.health += 3;
                char.trained = true;
                document.querySelector(".popup").remove();
                showTeamManagement(battleIndex);
            }
        }

        function healPlayer(charName, battleIndex) {
            const char = selectedTeam.find(c => c.name === charName);
            if (coins >= 10 && char.health < char.overall) {
                coins -= 10;
                char.health = char.overall;
                document.querySelector(".popup").remove();
                showTeamManagement(battleIndex);
            }
        }

        function buyWeapon(charName, weapon, battleIndex) {
            const char = selectedTeam.find(c => c.name === charName);
            if (!weapon || char.weapon === weapon) return;
            const newWeaponCost = weapons[weapon].cost;
            if (teamBudget >= newWeaponCost) {
                const oldWeaponBonus = weapons[char.weapon].bonus;
                teamBudget -= newWeaponCost;
                char.overall = char.overall - oldWeaponBonus + weapons[weapon].bonus;
                char.health = char.health - oldWeaponBonus + weapons[weapon].bonus;
                char.weapon = weapon;
                document.querySelector(".popup").remove();
                showTeamManagement(battleIndex);
            }
        }

        function sellWeapon(charName, battleIndex) {
            const char = selectedTeam.find(c => c.name === charName);
            if (char.weapon !== "גלוק") {
                const oldWeaponCost = weapons[char.weapon].cost;
                const oldWeaponBonus = weapons[char.weapon].bonus;
                teamBudget += Math.floor(oldWeaponCost / 2);
                char.overall = char.overall - oldWeaponBonus + weapons["גלוק"].bonus;
                char.health = char.health - oldWeaponBonus + weapons["גלוק"].bonus;
                char.weapon = "גלוק";
                document.querySelector(".popup").remove();
                showTeamManagement(battleIndex);
            }
        }

        function showCityManagement() {
            if (!bigBossDefeated) return;
            const cityDisplay = document.getElementById("city-management");
            cityDisplay.style.display = "flex";
            cityDisplay.innerHTML = `
                <h2>ניהול ${cityName}</h2>
                <p>תקציב: ${cityBudget.toLocaleString()} ₪ | אוכלוסייה: ${cityPopulation.toLocaleString()}</p>
                <div class="team-grid">
                    <div class="card">
                        <h3>שכונות</h3>
                        <p>${cityNeighborhoods.join(', ')}</p>
                        <button onclick="showCityMenu('neighborhoods')">נהל שכונות</button>
                    </div>
                    <div class="card">
                        <h3>תפקידים</h3>
                        <p>${Object.keys(assignedJobs).length} תפקידים מאוישים</p>
                        <button onclick="showCityMenu('jobs')">נהל תפקידים</button>
                    </div>
                    <div class="card">
                        <h3>שדרוגים</h3>
                        <p>${Object.values(cityUpgrades).filter(u => u).length}/3 שדרוגים</p>
                        <button onclick="showCityMenu('upgrades')">נהל שדרוגים</button>
                    </div>
                </div>
                <button onclick="showMainMenu()">חזור לתפריט ראשי</button>
            `;
            hideAllExcept("city-management");
            startCityIncome();
        }

        function startCityIncome() {
            setInterval(() => {
                cityBudget += 20 + (prostitutes.length * 30) + (cityUpgrades.newNeighborhood ? 40000 : 0) + (cityUpgrades.airport ? 100000 : 0) + (cityUpgrades.hotel ? 50000 : 0);
                if (Math.random() < 0.02) triggerCityEvent();
                updateCityDisplay();
            }, 5000);
        }

        function updateCityDisplay() {
            const cityDisplay = document.getElementById("city-management");
            if (cityDisplay.style.display === "flex") {
                cityDisplay.innerHTML = `
                    <h2>ניהול ${cityName}</h2>
                    <p>תקציב: ${cityBudget.toLocaleString()} ₪ | אוכלוסייה: ${cityPopulation.toLocaleString()}</p>
                    <div class="team-grid">
                        <div class="card">
                            <h3>שכונות</h3>
                            <p>${cityNeighborhoods.join(', ')}</p>
                            <button onclick="showCityMenu('neighborhoods')">נהל שכונות</button>
                        </div>
                        <div class="card">
                            <h3>תפקידים</h3>
                            <p>${Object.keys(assignedJobs).length} תפקידים מאוישים</p>
                            <button onclick="showCityMenu('jobs')">נהל תפקידים</button>
                        </div>
                        <div class="card">
                            <h3>שדרוגים</h3>
                            <p>${Object.values(cityUpgrades).filter(u => u).length}/3 שדרוגים</p>
                            <button onclick="showCityMenu('upgrades')">נהל שדרוגים</button>
                        </div>
                    </div>
                    <button onclick="showMainMenu()">חזור לתפריט ראשי</button>
                `;
            }
        }

        function triggerCityEvent() {
            const events = [
                { text: "תקלה במים! תיקון עולה 4,000 ₪", cost: 4000 },
                { text: "הצפה בשכונת רבין! תיקון עולה 10,000 ₪", cost: 10000 },
                { text: "שריפה במרכז העיר! תיקון עולה 15,000 ₪", cost: 15000 }
            ];
            const event = events[Math.floor(Math.random() * events.length)];
            const popup = document.createElement("div");
            popup.className = "popup";
            popup.innerHTML = `
                <div class="popup-content">
                    <h3>אירוע בעיר!</h3>
                    <p>${event.text}</p>
                    <button onclick="cityBudget -= ${event.cost}; this.parentElement.parentElement.remove(); updateCityDisplay()">תקן (${event.cost.toLocaleString()} ₪)</button>
                    <button onclick="this.parentElement.parentElement.remove()">התעלם</button>
                </div>
            `;
            document.body.appendChild(popup);
        }

        function showCityMenu(section) {
            const popup = document.createElement("div");
            popup.className = "popup";
            popup.innerHTML = `<div class="popup-content"><h2>ניהול ${cityName}</h2>`;
            if (section === "neighborhoods") {
                popup.innerHTML += `
                    <h3>שכונות</h3>
                    ${cityNeighborhoods.map((n, i) => `<div>${n} <button onclick="changeNeighborhoodName(${i})">שנה שם (1,000,000 ₪)</button></div>`).join('')}
                    <h3>זונות (${prostitutes.length}/4)</h3>
                    ${prostitutesList.filter(p => !prostitutes.includes(p)).map(p => `<button onclick="hireProstitute('${p}')">${p} (+30 ₪/5ש)</button>`).join('')}
                    <h3>מכירת מבנים</h3>
                    ${buildings.filter(b => !b.sold).map(b => `<button onclick="sellBuilding('${b.name}')">${b.name} (${b.value.toLocaleString()} ₪)</button>`).join('')}
                `;
            } else if (section === "jobs") {
                popup.innerHTML += `
                    <h3>תפקידים</h3>
                    ${Object.keys(cityJobs).map(job => `
                        <div>
                            ${job}: ${cityJobs[job].toLocaleString()} ₪
                            <span>${assignedJobs[job] ? `(${assignedJobs[job]})` : ''}</span>
                            <button onclick="assignJob('${job}')">בחר עובד</button>
                        </div>
                    `).join('')}
                `;
            } else if (section === "upgrades") {
                popup.innerHTML += `
                    <h3>שדרוגים</h3>
                    <button onclick="buyNewNeighborhood()" ${cityUpgrades.newNeighborhood ? "disabled" : ""}>שכונה חדשה (10,000,000 ₪, +4,000 תושבים, +40,000 ₪/5ש)</button>
                    <button onclick="buyAirport()" ${cityPopulation < 50000 || cityUpgrades.airport ? "disabled" : ""}>נמל תעופה (50,000,000 ₪, +100,000 ₪/5ש)</button>
                    <button onclick="buyHotel()" ${cityUpgrades.hotel ? "disabled" : ""}>מלון (20,000,000 ₪, +3,000 תושבים, +50,000 ₪/5ש)</button>
                `;
            }
            popup.innerHTML += `
                <button onclick="changeCityName()">שנה שם עיר (3,000,000 ₪)</button>
                <button onclick="this.parentElement.parentElement.remove()">סגור</button>
            </div>`;
            document.body.appendChild(popup);
        }

        function changeCityName() {
            if (cityBudget >= 3000000) {
                const newName = prompt("הזן שם חדש לעיר:");
                if (newName) {
                    cityBudget -= 3000000;
                    cityName = newName;
                    updateCityDisplay();
                    document.querySelector(".popup").remove();
                    showCityMenu('neighborhoods');
                }
            } else {
                alert("אין מספיק תקציב!");
            }
        }

        function changeNeighborhoodName(index) {
            if (cityBudget >= 1000000) {
                const newName = prompt(`הזן שם חדש לשכונה ${cityNeighborhoods[index]}:`);
                if (newName) {
                    cityBudget -= 1000000;
                    cityNeighborhoods[index] = newName;
                    updateCityDisplay();
                    document.querySelector(".popup").remove();
                    showCityMenu('neighborhoods');
                }
            } else {
                alert("אין מספיק תקציב!");
            }
        }

        function hireProstitute(name) {
            if (prostitutes.length < 4) {
                prostitutes.push(name);
                document.querySelector(".popup").remove();
                showCityMenu('neighborhoods');
            } else {
                alert("מגיע עד 4 זונות!");
            }
        }

        function sellBuilding(name) {
            const building = buildings.find(b => b.name === name);
            if (!building.sold) {
                cityBudget += building.value;
                building.sold = true;
                document.querySelector(".popup").remove();
                showCityMenu('neighborhoods');
            }
        }

        function assignJob(job) {
            const popup = document.createElement("div");
            popup.className = "popup";
            popup.innerHTML = `
                <div class="popup-content">
                    <h3>בחר עובד ל${job}</h3>
                    <div class="team-grid">
                        ${selectedTeam.map(char => `
                            <div class="card" onclick="assignJobToPlayer('${job}', '${char.name}')">
                                <img src="${char.image}" alt="${char.name}">
                                <div>${char.name}</div>
                            </div>
                        `).join('')}
                    </div>
                    <button onclick="this.parentElement.parentElement.remove()">סגור</button>
                </div>
            `;
            document.body.appendChild(popup);
        }

        function assignJobToPlayer(job, charName) {
            assignedJobs[job] = charName;
            document.querySelector(".popup").remove();
            showCityMenu('jobs');
        }

        function buyNewNeighborhood() {
            if (cityBudget >= 10000000 && !cityUpgrades.newNeighborhood) {
                cityBudget -= 10000000;
                cityPopulation += 4000;
                cityUpgrades.newNeighborhood = true;
                updateCityDisplay();
                document.querySelector(".popup").remove();
                showCityMenu('upgrades');
            }
        }

        function buyAirport() {
            if (cityBudget >= 50000000 && cityPopulation >= 50000 && !cityUpgrades.airport) {
                cityBudget -= 50000000;
                cityUpgrades.airport = true;
                updateCityDisplay();
                document.querySelector(".popup").remove();
                showCityMenu('upgrades');
            }
        }

        function buyHotel() {
            if (cityBudget >= 20000000 && !cityUpgrades.hotel) {
                cityBudget -= 20000000;
                cityPopulation += 3000;
                cityUpgrades.hotel = true;
                updateCityDisplay();
                document.querySelector(".popup").remove();
                showCityMenu('upgrades');
            }
        }

        showMainMenu();
    </script>
</body>
</html>
